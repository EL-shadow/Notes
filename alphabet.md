Disclaimer:
* После просмотра Видео решил собрать инфу - суммаризация я.браузером + записии из слайдов + мои заметки.

# НГ2020: Азбука полезных команд, Влад Росков
Оригинал видео https://www.youtube.com/watch?v=f9wIvrKSJkM
Слайды: https://vk.com/doc-114366489_584699790


## Введение

* Доклад посвящен облегчению работы с консолью Linux.
* Автор делится опытом помощи другим пользователям.
* Цель доклада – показать полезные консольные утилиты.

## Структура доклада

* Доклад состоит из 26 слайдов, по одному на каждую букву алфавита.
* На каждую букву будет представлена одна утилита.
* Зрителей просят угадывать, какую утилиту покажет автор.

## Буква A

* Утилита `aria2` для скачивания файлов из интернета.
* aria2 поддерживает несколько потоков скачивания.
* Умеет скачивать торренты, причем можно дать урл торрента, она его выкачает а потом начнет качать содержимое.
* Умеет докачивать файлы без аргументов (так умеет с флагом continue `wget -c`)

`apt -y install aria2`
`aria2c -x5 http://.../` — качать в 5 потоков
`aria2c xxx.torrent`
`aria2c magnet:magnet:?xt=urn:btih:c12fe` 

## Буква B

* Утилита `byobu` для создания виртуальных консолей.
* Позволяет создавать несколько вкладок и переключаться между ними.
* Поддерживает разбиение окна на части для создания дашбордов.
```
Ctrl-A C New tab Alt ← → Chg tabs
Ctrl-D закрыть tab
F7 Scrollback (Enter exit)
Ctrl-A % and Ctrl-A | Split window
Shift ← → ↑ ↓ Chg splits focus
Alt-Shift ←→↑↓ Resize splits
Ctrl-A D Detach
```


## Буква С

* Шорткаты с Ctrl: Ctrl D для выхода из сессии, Ctrl L для очистки экрана, Ctrl R для поиска по истории команд.
* Ctrl U для очистки текущей строки.
* Alt Shift # для сохранения команды в истории.

```
Ctrl- Shortcuts
Ctrl-D EOF, exit shell
Ctrl-R reverse-i-search
Ctrl-L Clear screen 
```

## Буква D - Доллар кавычки в Bash

* Вопрос о передаче бинарных данных в параметры программы.
* Ответ: использование кавычек "".
* Здесь игра слова буква Д - доллар кавычки
* В Bash существуют двойные кавычки, одинарные кавычки и доллар кавычки.
* Доллар кавычки интерпретируют последовательности со слэшами.
* Программа может принимать аргументы в виде сырых байтов.
* Использование доллар кавычек позволяет передать бинарные данные.
```
$'\x44\x6f\x6c\x6c\x61\x72'
# printf $'hello\n\'world\'\n'
hello
'world' 
```

## E - Команда echo

* Команда echo имеет флаги `-n` и `-e` для управления выводом.
* `-n` предотвращает перевод строки в конце вывода.
* `-e` включает интерпретацию слэшевых последовательностей.
```
-n No newline
-e Eval \x..
echo -n hello | md5sum - посчитает правильно, т.к. не добавит перевод строки к hello
echo -e '\x68\x65\x6C\x6C\x6F'
```

## F - Команда find

* Команда find ищет файлы по маске.
* Флаг `-iname` делает поиск кейси-интенсивным.
* Флаг `-ls` выводит информацию о файлах, включая размер и дату модификации.

### Фильтры по дате модификации

* Ключи `-mmin` и `-cmin` фильтруют файлы по дате модификации.
* Пример: `-mmin -60` показывает файлы, модифицированные менее 60 минут назад.

### Удаление файлов с помощью find

* Флаг `-delete` позволяет удалять файлы, найденные find.
* Пример: `find . -delete` удаляет все найденные файлы.

### Различие между модификацией и изменением

* Команда touch меняет дату модификации, но не дату изменения.
* Изменение даты изменения можно использовать для выявления атак.

### Запуск скриптов с помощью find

* Флаг `-exec` позволяет запускать скрипты для каждого найденного файла.
* Пример: `find . -exec sh -c "echo $1" {} \;` запускает скрипт для каждого файла.

```
-name, -iname is Case Insensitive
-ls List found stuff
-mmin, -cmin By time
find dir_to_delete/ -delete
-exec ./my_script.sh {} \; 
```

## G - Команда grep

* Флаг `-a` отключает использование регулярных выражений.
* Флаг `-p` переключает grep на использование Perl-совместимых регулярных выражений.
* Пример: `grep -a "\."` ищет только литеральные точки.

### Использование grep

* grep ищет строку во всех файлах, включая сжатые архивы.
* Можно использовать рекурсивный поиск и опцию "-z" для разжатия архивов.
* Пример поиска в логах с использованием grep и zgrep.

### Проблемы с подсветкой результатов grep

* grep не подсвечивает найденные строки, что неудобно.
* Можно использовать опцию "-i" для подсветки найденных строк.
* Пример рекурсивного поиска с использованием grep.

### Поиск процессов с помощью grep

* При поиске процессов grep может возвращать себя как результат.
* Обертывание символов в квадратные скобки предотвращает это.
```
fgrep No regexps grep -P Real regexps
grep -r Recurse zgrep In .gz
grep -C10 -A after -B before
ps auxf | grep [b]ash --color 
```


## H - Использование htop для мониторинга процессов

* htop показывает список процессов в консольном виде.
* Позволяет убивать процессы и выделять несколько процессов одновременно.
* Возможность трассировки системных вызовов с помощью кнопки "s".
```
Process list: htop
F6 Sort by: CPU, MEM
Space = highlight
F9 Kill
S strace
```


## I - Использование ipython для Python-разработки

* ipython предоставляет автодополнение и табуляцию.
* Можно встраивать ipython в уже написанные скрипты для интерактивного дебага.
* Пример использования ipython для отладки скрипта.

```
pip3 install ipython
 
from IPython import embed; embed() <-- вставить в точке где нужен дебаг; доступны переменные. выход Ctrl-D
```

## J - Ошибки при выходе из программ

* Ctrl+Z не завершает процесс, а отправляет его в фон.
* Это может привести к оставшимся незавершенным процессам.
* Команда jobs показывает все фоновые процессы.
### Команды fg и bg

* Команда fg возвращает команду на передний план.
* Команда bg отправляет команду на задний план.
* Пример использования: переключение на Vim и завершение задачи.

### Выполнение команд в фоне

* Команда bg позволяет выполнять команду в фоне.
* Пример с Vim: Vim не может выполняться в фоне из-за необходимости принимать команды.
* Пример с echo: echo может выполняться в фоне.

```
Ctrl-Z Stop and Background
cmd & Run in Background
fg Foreground bg Background
jobs List backgrounded
kill -9 %1 
kill -9 `jobs -p` 
```


## K - Завершение задач

* Команда kill с номером задачи завершает процесс.
* Пример: kill -9 %6 завершает шестую задачу.
* Команда jobs -p выводит номера процессов.

### Сигналы stop и continue

* Сигнал stop замораживает процесс.
* Сигнал continue размораживает процесс.
* Пример использования: заморозка и разморозка текстового редактора.

### Посылка сигналов всем процессам

* Команда kill -1 отправляет сигнал всем процессам.
* Пример использования: очистка всех процессов для устранения сетевых проблем.

### Сигналы ctrl+c и ctrl+backslash

* Ctrl+c завершает процесс.
* Ctrl+backslash аварийно завершает процесс и сбрасывает отладочную информацию.
* Настройка создания отладочных файлов.

```
kill 1234 Gently 
kill -9 1234 Hard
kill -STOP Freeze 
kill -CONT Unfreeze
(X_x) kill -9 -1 (x_X)
Ctrl-\ Send SIGABRT 
```

## L - Архиваторы в Linux

* Стандартные архиваторы: gzip, bzip2, tar.
* Многопоточный архиватор lbz2: работает в 10 раз быстрее обычного bzip2.
* Пример: сжатие файла с lbz2 занимает 2 секунды против 9 секунд с обычным bzip2.

```
Compression		bzip2 42 sec
				lbzip2 5 sec
Decompression	bzip2 40 sec
				lbzip2 4 sec
```

## M - Мониторинг изменений в выводе команды

* Инструмент "mmwatch" мониторит изменения в выводе команды и считает скорость изменений.
* Устанавливается через GitHub, представляет собой Python-скрипт.
* Пример использования: запуск команды "iwconfig" каждые две секунды для мониторинга скорости передачи данных.

### Мониторинг размера файлов

* "mmwatch" может мониторить размер файлов, показывая скорость его изменения.
* Полезно для отслеживания загрузки видео на FTP.

Скачать
https://github.com/cloudflare/cloudflare-blog/blob/master/2017-06-29-ssdp/mmwatch
Положить в usr/local/bin
поменять права chmod a+x

## N - Команда "ncdu" для анализа дискового пространства

* "ncdu" показывает занимаемое место на диске в древовидном формате.
* Позволяет удалять ненужные файлы и сортировать по размеру и количеству файлов.
* Пример использования: удаление ненужных файлов и эксплойтов.

```
What takes up space: ncdu
← → Navigate
s Sort by size
C Sort by counts
c Display counts
d Delete 
```

## O - Команда "od" для вывода файла в виде HEX

* "od" выводит файл в восьмеричном формате по умолчанию.
* Для вывода в виде HEX используется ключ "-t x1z".
* Пример: вывод файла в виде HEX без использования команды "xxd".

```
Universal hex dump: od
od -tx1z
od -Ax Hex addresses
od -t x1 Hex output
od -t x1z Hex output w/chars
od -v Don't merge to * 
```

od выводит в начале адреса байтов потом восьмеричные байты
отбросим адреса `-An`
и выведем по одному байту `-to1`

### Другие варианты `-t`:

| Флаг | Описание | Пример вывода для `"A"` (байт `0x41`) |
|------|----------|--------------------------------------|
| `-to1` | Восьмеричные байты | `101` (65 в десятичной) |
| `-tx1` | Шестнадцатеричные байты (`x`) | `41` |
| `-tu1` | Десятичные байты (`u`) | `65` |
| `-tc` | Символьное представление (`c`) | `A` |


## P - Команда "pv" для отображения прогресса

* "pv" рисует прогресс-бар при передаче данных.
* Используется как замена команды "cat" для отображения прогресса.
* Позволяет мониторить сжатие файлов, передачу данных по сети и другие процессы.

```
Inline progress bar: pv
pv file | ./prog ./app1 | pv | ./app2
tar cz /home | pv > home.tar.gz
pv home.tar.gz | nc -nvlp 7878
pv -d PID Monitor other process
-L Limit speed -l Lines 
```

## Q - Запуск бинарных файлов с другой архитектурой

* "qemu-user" позволяет запускать бинарные файлы для другой архитектуры на Linux.
* Можно использовать Docker-образы с других архитектур.
* Для этого нужно включить экспериментальные функции в настройках Docker.

```
APT: qemu-user-static libc6-armel-cross
qemu-arm -L /usr/arm-linux-gnu ./...
docker run --rm -ti arm32v7/busybox
docker pull --platform linux/arm ubuntu
daemon.json: {"experimental": true}
```

## R - Ripgrep

* Ripgrep работает в пять раз быстрее обычного grep.
* Позволяет искать в сжатых файлах с ключом -z.
* Устанавливается из репозиториев или бинарных пакетов.

```
Grep really fast: rg
PCRE Regexps by default
/usr/share# time grep -r root
real 0m3.423s
/usr/share# time rg --binary root
real 0m0.946s
-z In compressed 
```

## S - socat

* Socat соединяет любые две сущности через TCP.
* Позволяет прослушивать порты и пробрасывать порты.
* Можно использовать с SOCKS прокси и эмулировать HTTPS.

```
Connect everything: socat
socat tcp-l:7878,fork,reuseaddr exec:./app
socat tcp-l:7878,fork tcp:43.65.87.21:80
socat - socks4a:127.0.0.1:ya.ru:80
,socksport=9050
openssl-listen:7878,cert=c,key=k,verify=0 
```

## T - tar

* Tar превращает несколько файлов в один поток данных.
* Можно использовать для скачивания большого количества файлов.
* Удобно для сжатия и распаковки файлов с помощью других программ.

```
tar
# du -sh services
43240 services
ssh host 'cd /home; tar c services | lbzip2'
| pv -s 43240k | (cd /mnt/d/ctf/cybrics ;
lbzip2 -d | tar x)
```

## U - исправление ошибок в командах

* Используйте стрелку вверх для возврата к предыдущей команде.
* Работает в Windows, Linux и других командных интерфейсах.

## V - Virtualenv и Wireshark

* Virtualenv изолирует окружение для работы с Python.
* Wireshark позволяет сниффить трафик в реальном времени.
* Можно собирать команды для прослушивания трафика на удаленном сервере.

```
Isolate Pythons: virtualenv
virtualenv my
. ./my/bin/activate
pip install anything
...
deactivate 
```

```
Wireshark
ssh host 'tcpdump -i eth0
-U -w - not port 22'
| wireshark -k -i -
Also, cuishark
```

## X - xxd
```
Good hexdump: xxd
xxd /bin/bash
xxd -r Unhex
xxd -ps Continuous hexes
xxd -r -ps Unhex continuous
```


## Y - youtube-dl

```
Download from YouTube: youtube-dl
pip3 install -U youtube-dl
apt -y install ffmpeg
youtube-dl youtu.be/smhi6jts97I
-F List formats -f DL format
(e.g. audio)
```

## Z - Zstd

* Zstd — новый архиватор от Facebook.
* Быстро сжимает и распаковывает файлы.
* Подходит для быстрой передачи больших объемов данных.

```
Good fast compression: zstd
# pv test.txt | lbzip2 > test.bz2
778MiB 0:00:05 [ 134MiB/s] 14M test.bz2
# pv test.txt | zstd > test.zst
778MiB 0:00:01 [ 749MiB/s] 21M test.zst
# lbzip2 -d < test.bz2 | pv > /dev/null
778MiB 0:00:02 [ 349MiB/s]
# zstd -d < test.zst | pv > /dev/null
778MiB 0:00:00 [1.47GiB/s] 
```

## Презентация и ноутбук

* Презентация создана с помощью эмулятора терминала Cool Retro Term.
* Ноутбук MSI.

